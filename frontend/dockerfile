# ============================================================
# LancasterLink Frontend Dockerfile
#
# Multi-stage build:
#   Stage 1 – Build frontend assets (Node.js)
#   Stage 2 – Serve with Nginx + reverse proxy config
#
# If no Node build step is needed (plain HTML/CSS/JS), the
# build stage simply copies the source files through.
# ============================================================

# ----- Stage 1: Build -----
FROM node:20-alpine AS build

WORKDIR /app

# Copy package files first (leverage Docker layer caching)
COPY package*.json ./

# Install dependencies (if package.json exists, otherwise this is a no-op)
RUN if [ -f package.json ]; then npm ci --production=false; fi

# Copy the rest of the frontend source
COPY . .

# Build the production bundle (if a build script is defined)
RUN if [ -f package.json ] && grep -q '"build"' package.json; then \
        npm run build; \
    else \
        mkdir -p dist && cp -r *.html css/ js/ assets/ dist/ 2>/dev/null || true; \
    fi

# ----- Stage 2: Serve -----
FROM nginx:1.27-alpine

# Remove default Nginx config
RUN rm /etc/nginx/conf.d/default.conf

# Copy custom Nginx configuration (reverse proxy + static serving)
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy built frontend assets from the build stage
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
